---
title: "suwo"
subtitle: Access nature media from online repositories
pagetitle: Access nature media from online repositories
author: 
- Jorge Elizondo & <a href="https://marce10.github.io/">Marcelo Araya-Salas</a>
date:  "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    self_contained: yes
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
vignette: >
   %\VignetteIndexEntry{1. Package overview}
   %\usepackage[utf8]{inputenc}
   %\VignetteEncoding{UTF-8}
   %\VignetteDepends{Rraven}
   %\VignetteDepends{viridis}
   %\VignetteDepends{suwo}
   %\VignetteDepends{kableExtra}
   %\VignetteEngine{knitr::rmarkdown}     
editor_options: 
  chunk_output_type: console
params:
  EVAL: !r identical(Sys.getenv("NOT_CRAN"), "true")
---

&nbsp;

```{r setup, eval = TRUE, echo = FALSE, message=FALSE}

library(knitr)
library(htmlwidgets)
library(suwo)

# Create custom printing method
.print_df <- function(x, highlight = NULL, ...) {
  kbl <- kableExtra::kable(
    head(as.data.frame(x)),
    align = "c",
    row.names = FALSE,
    format = "html",
    escape = FALSE
  )
  
  if (!is.null(highlight))
    kbl <- kableExtra::column_spec(kbl, column = which(names(x) %in% highlight), background = "#ccebff", bold = TRUE)
  
  kbl <- kableExtra::kable_styling(kbl, bootstrap_options = "striped", font_size = 14)
  kbl <- kableExtra::scroll_box(kbl, width = "100%", height = "300px")
  
  asis_output(kbl)
}

# Register custom data frame print method
registerS3method("knit_print", "data.frame", .print_df)

# Global chunk options
knitr::opts_chunk$set(
  fig.width = 5, 
  fig.height = 3.5,
  dpi = 70,
  comment = "",
  out.width = "80%",
  fig.align = "center",
  message = TRUE,
  warning = TRUE
)

options(width = 100, max.print = 100)


```


<div class="alert alert-info">

This vignette provides an overview of the suwo package and its functionalities. For detailed information on each function, please refer to the [function reference](https://maRce10.github.io/suwo/reference/index.html) or use the help files within R (e.g., `?query_gbif`).

</div>

The suwo package is designed to simplify the retrieval of nature media (mostly photos, audio files and videos) across multiple online biodiversity databases. This vignette provides an overview of the packageâ€™s core querying functions, the searching and downloading of media files, and the compilation of metadata from various sources. 

# Installation

```{r, eval = FALSE, echo = FALSE}

#Install from CRAN:

# From CRAN would be
install.packages("suwo")

#load package
library(suwo)


```

Install the latest development version from GitHub:

```{r, eval = FALSE}

# install package
remotes::install_github("maRce10/suwo")

#load packages
library(suwo)

```

# Basic workflow for obtaining nature media files

Finding data using suwo follows a basic sequence. The following diagram illustrates this workflow and the main functions involved:

<center><img src="workflow_diagram.png" alt="suwo workflow diagram" width="100%"></center>

<br>
Here is a description of each step:

1. Queries regarding a specific taxonomic group (typically a species name) is submitted through one of the available query functions (`query_repo_name()`) that connect to five different online repositories. The output of these queries is a data frame containing metadata associated with the media files (e.g., species name, date, location, etc, see below). 

1. If multiple repositories are queried, the resulting metadata data frames can be merged into a single data frame using the `merge_query_results()` function. 

1. Users can also check for duplicate records in their datasets using the `find_duplicates()` function.
 
1. Users can then download the media files associated with the metadata using the `download_media()` function. 

1. Finally, users can update their datasets with new records by re-running the queries and merging the new results with their existing datasets using the `update_query()` function. 


# Query functions

The following table summarizes the available suwo query functions and the types of metadata they retrieve:

```{r query_summary_table, echo=FALSE, results='asis', message=FALSE}

library(knitr)
library(kableExtra)

load("~/Dropbox/R_package_testing/suwo/R/sysdata.rda")

tur_ruf_sound_list <- tur_ruf_list[grep("sound", names(tur_ruf_list))]
tur_ruf_sound_list <- tur_ruf_sound_list[order(names(tur_ruf_sound_list))]

# split by "_" and keep the first part
names(tur_ruf_sound_list) <- gsub("_sounds", "", names(tur_ruf_sound_list))

Repository <- sapply(tur_ruf_sound_list, function(x) x[1, "repository"])
Function <- sapply(tur_ruf_sound_list, function(x) attributes(x)$query_call[[1]])

Function <- sapply(Function, as.character)

file_types <- sapply(Function, function(x) paste(formals(x)$format, collapse = ", "))
file_types <- gsub("c, ", "", file_types)
file_types[Function == "query_xenocanto"] <- "sound"
 
urls = c(
    gbif = "https://www.gbif.org/",
    inaturalist = "https://www.inaturalist.org/",
    macaulay = "https://www.macaulaylibrary.org/",
    observation = "https://observation.org/",
    wikiaves = "https://www.wikiaves.com.br/",
    `xeno-canto` = "https://www.xeno-canto.org/"
  )

urls <- urls[match(names(tur_ruf_sound_list), names(urls))]

 token <- c(
    gbif = "No",
    inaturalist = "No",
    macaulay = "No",
    observation = "Yes",
    wikiaves = "No",
    `xeno-canto` = "Yes"
  )

token <- token[match(names(tur_ruf_sound_list), names(token))]


tax_level <-  c(
    gbif = "Species",
    inaturalist = "Species",
    macaulay = "Species",
    observation = "Species",
    wikiaves = "Species",
    `xeno-canto` = "Species, genus, family"
  )

tax_level <- tax_level[match(names(tur_ruf_sound_list), names(tax_level))]

geo_cover <-  c(
    gbif = "Worldwide",
    inaturalist = "Worldwide",
    macaulay = "Worldwide",
    observation = "Worldwide",
    wikiaves = "Brazil",
    `xeno-canto` = "Worldwide"
  )

geo_cover <- geo_cover[match(names(tur_ruf_sound_list), names(geo_cover))]


colnames <- lapply(tur_ruf_sound_list, names)

colnames <- lapply(colnames, function(x) setdiff(x, suwo:::.format_query_output(only_basic_columns = TRUE)))

additional_data <- sapply(colnames, function(x) paste(x, collapse = ", "))

additional_data <- additional_data[match(names(tur_ruf_sound_list), names(additional_data))]

query_summary <- data.frame(
  Function = Function,
  Repository = Repository,
  `URL link` = urls,
  `File types` = file_types,
  `Requires token` = token,
  `Taxonomic level` = tax_level,
  `Geographic coverage` = geo_cover,
  `Additional data` = additional_data,
  stringsAsFactors = FALSE, 
check.names = FALSE
)


 query_summary$`URL link` <- kableExtra::cell_spec(query_summary$`URL link`, "html", link = query_summary$`URL link`, new_tab = TRUE)

 query_summary$Function <- kableExtra::cell_spec(query_summary$Function, "html", link = paste0("https://marce10.github.io/suwo/reference/", query_summary$Function, ".html"), new_tab = TRUE)
 
query_summary[, names(query_summary) != "Additional data"] |>
  kableExtra::kbl(
    caption = "Table 1: Summary of query functions.",
    format = "html",
    escape = FALSE, 
    row.names = FALSE
  ) |>
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position = "left"
  )

```

This is an example code of a query of _Turdus rufiventris_ (a bird species) sounds from Xeno-canto and Wikiaves:

```{r, eval = FALSE}
# Load suwo package
library(suwo)

# Query Xeno-canto for Turdus rufiventris sounds
t_ruf_xc_data <- query_xenocanto(term = "Turdus rufiventris")

head(t_ruf_xc_data, 4)
```

```{r, echo=FALSE}

head(tur_ruf_sound_list$`xeno-canto`[, suwo:::.format_query_output(only_basic_columns = TRUE)], 4)

```


```{r, eval = FALSE}
# Query Wikiaves for Turdus rufiventris sounds
t_ruf_wa_data <- query_wikiaves(term = "Turdus rufiventris", format = "sound")

head(t_ruf_wa_data, 4)
```

```{r, echo=FALSE}

head(tur_ruf_sound_list$wikiaves[, suwo:::.format_query_output(only_basic_columns = TRUE)], 4)

```


By default all query function return the `r length(suwo:::.format_query_output(only_basic_columns = TRUE))` most basic metadata fields associated with the media files. Here is the definition of each field:

 - **repository**: Name of the repository
 - **format**: Type of media file (e.g., sound, photo, video)
 - **key**: Unique identifier of the media file in the repository
 - **species**: Species name associated with the media file (Note taxonomic authority may vary among repositories)
 - **date***: Date when the media file was recorded/photographed (in YYYY-MM-DD format or YYYY if only year is available)
 - **time***: Time when the media file was recorded/photographed (in HH:MM format)
 - **user_name***: Name of the user who uploaded the media file
 - **country***: Country where the media file was recorded/photographed
 - **locality***: Locality where the media file was recorded/photographed
 - **latitude***: Latitude of the location where the media file was recorded/photographed (in decimal degrees) 
 - **longitude***: Longitude of the location where the media file was recorded/photographed (in decimal degrees)
 - **file_url**: URL link to the media file (used to download media files)
 - **file_extension**: Extension of the media file (e.g., .mp3, .jpg, .mp4)
 
_* Can contain missing values (NAs)_

Users can also download all available metadata by setting the `all_data = TRUE`. These are the additional metadata fields, on top of the basic fields, that can be retrieved by each query function:

```{r, echo=FALSE, results='asis', message=FALSE}

query_summary[,c("Function", "Additional data")] |>
  kableExtra::kbl(
    caption = "Table 2: Additional metadata per query function.",
    format = "html",
    escape = FALSE,
    row.names = FALSE
  ) |>
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    position = "left"
  )

```


<div class="alert alert-warning">

<font size = "4">Obtaining raw data</font>

By default the package standardizes the information in the basic fields (detailed above) in order to facilitate the compilation of metadata from multiple repositories. However, in some cases this may result in loss of information. For instance, some repositories allow users to provide "morning" as a valid time value, which are converted into NAs by suwo. In such cases, users can retrieve the original data by setting the `raw_data = TRUE` in the query functions and/or global options (`options(raw_data = TRUE)`). But note that subsequent data manipulation functions (e.g., `merge_query_results()`, `find_duplicates()`, etc) will not work properly as the basic fields are not standardized.

</div>

# Combine metadata from multiple repositories

The `merge_query_results()` function allows users to combine metadata data frames obtained from multiple query functions into a single data frame. This function ensures that the combined data frame has a consistent structure, with all basic metadata fields included. The function will match the basic columns of all data frames. Data from additional columns will only be combined if the names from the different repositories match. The function will return a data frame 


```{r}

```


# Find duplicated records

# Update metadata


# Donwload media files

<font size="4">Session information</font>

```{r session info, echo=F}

sessionInfo()

```

