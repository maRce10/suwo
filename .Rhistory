httr2::resp_is_error(response)) {
if (verb) {
.message(paste("No connection to", name),
as = "failure")
}
return(FALSE)
}
content <- httr2::resp_body_string(response, encoding = "UTF-8")
if (grepl("Could not connect to the database", content)) {
if (verb) {
.message(paste(name, "website is apparently down"), as = "failure")
}
return(FALSE)
}
}
return(TRUE)
}
# look up species taxon code for Macaulay queries
.taxon_code_search <-
function(species = getOption("species"),
ml_taxon_code = ml_taxon_code) {
taxon_code <- ml_taxon_code$SPECIES_CODE[
ml_taxon_code$SCI_NAME == species &
!is.na(ml_taxon_code$SCI_NAME)]
if (length(taxon_code) > 0) {
return(taxon_code[1])
} else {
return(NULL)
}
}
# get if an object is an error from try()
.is_error <- function(x){
is(x, "try-error")
}
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
rlang::last_trace()
source("~/Dropbox/R_package_testing/suwo/R/internal_functions.R")
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
test_that("search Glaucis dohrnii images", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "image",
path = tempdir())
expect_true(nrow(df1) >= 10)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
new_csv_file_list <- vector(length = seq_len(nrow(date_ranges_df)))
new_csv_file_list <- vector(length = nrow(date_ranges_df))
new_csv_file_list
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
test_that("search Glaucis dohrnii images", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "image",
path = tempdir())
expect_true(nrow(df1) >= 10)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
test_that("null taxon", {
df1 <- query_macaulay(species = "asdasdasd",
format =  "image",
path = tempdir())
expect_true(is.null(df1))
})
nrow(df1)
run.all()
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
new_csv_file_list <- vector(length = nrow(date_ranges_df), type = "character")
new_csv_file_list <- vector(length = nrow(date_ranges_df), type = "character")
new_csv_file_list <- vector(length = nrow(date_ranges_df), mode = "character")
new_csv_file_list
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
species = 'Glaucis dohrnii'
format =  "sound"
path = tempdir()
verbose = getOption("verbose", TRUE)
all_data = getOption("all_data", FALSE)
raw_data = getOption("raw_data", FALSE
files = NULL
dates = NULL
raw_data = getOption("raw_data", FALSE)
taxon_code_info = ml_taxon_code
ml_format <- switch(format,
sound = "audio",
image = "photo",
`video` = "video")
# get species ML taxon code
if (is.null(species) & is.null(files)){
# either species or files must be supplied
.message(text =
paste("Either 'species' or 'files' must be supplied", species, sep = ""),
as = "failure")
}
is.null(files)
# set output message wording
out_text <- "{n} matching record{?s} found"
nfiles <- NULL
taxon_code <- .taxon_code_search(species, ml_taxon_code = taxon_code_info)
# function will stop here
if (is.null(taxon_code)) {
.message(text =
paste("No matching species found for ", species, sep = ""),
as = "failure")
return(invisible(NULL))
}
# Use the unified connection checker
if (!.checkconnection(verb = verbose, service = "macaulay")) {
return(invisible(NULL))
}
# Apply to all elements
if (!is.null(dates)) {
date_ranges_df <- .date_ranges(x = dates)
} else {
date_ranges_df <- data.frame(start_year = NA)
}
new_csv_file_list <- vector(length = nrow(date_ranges_df), mode = "character")
new_csv_file_list
for (i in seq_len(nrow(date_ranges_df))) {
if (!is.null(dates)) {
# extract date range to let users know while batching
date_range <- if (date_ranges_df$start_month[i] == 1 &&
date_ranges_df$end_month[i] == 12) {
if (date_ranges_df$start_year[i] !=  date_ranges_df$end_year[i]) {
paste0(date_ranges_df$start_year[i],
"-",
date_ranges_df$end_year[i])
} else {
date_ranges_df$start_year[i]
}
} else {
paste0(
month.abb[date_ranges_df$start_month[i]],
"-",
date_ranges_df$start_year[i],
" - ",
month.abb[date_ranges_df$end_month[i]],
"-",
date_ranges_df$end_year[1]
)
}
if (nrow(date_ranges_df) > 1) {
cli_bullets(c("*" = paste0(
"Query ",
i,
" of ",
nrow(date_ranges_df),
" (",
date_range,
"):"
)))
}
}
# let users know where to save the file
cat(
paste("A browser will open the macaulay library website.",
"Save the .csv file ('export' button) to this directory:")
)
cat(normalizePath(path), "/", sep = "")
cat("   (R is monitoring for new .csv files. Press ESC to stop the function)")
# pause 3 s so users can read message but only in the first query in
# a batch
if (i == 1)
Sys.sleep(3)
# construct the search URL
search_url <- paste0(
"https://search.macaulaylibrary.org/catalog?view=list&mediaType=",
ml_format,
"&taxonCode=",
taxon_code
)
# if (!is.na(date_ranges_df$start_year[i])) {
if (!is.null(dates)) {
search_url <- paste0(
search_url,
"&beginYear=",
date_ranges_df$start_year[i],
"&endYear=",
date_ranges_df$end_year[i]
)
if (date_ranges_df$start_month[i] != 1 ||
date_ranges_df$end_month[i] != 12) {
search_url <- paste0(
search_url,
"&beginMonth=",
date_ranges_df$start_month[i],
"&endMonth=",
date_ranges_df$end_month[i]
)
}
}
# open the search URL in the default web browser
utils::browseURL(search_url)
# monitor for new files
new_csv_file_list[length(new_csv_file_list) + 1] <-
.monitor_new_files(path  = path)
# let users know the name of the csv file that was read
cat("\nThe data will be read from the file:", suffix = " ")
cat(paste(new_csv_file_list[length(new_csv_file_list)], "\n"))
}
new_csv_file_list
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
test_that("search Glaucis dohrnii images", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "image",
path = tempdir())
expect_true(nrow(df1) >= 10)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
source("~/Dropbox/R_package_testing/suwo/R/query_macaulay.R")
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
test_that("search Glaucis dohrnii images", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "image",
path = tempdir())
expect_true(nrow(df1) >= 10)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
rlang::last_trace()
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound reading existing file", {
tf <- tempfile()
write.csv(file = tf, x = suwo:::vignette_metadata$t_rufiventris[1:3, ])
df1 <- query_macaulay(path = tempdir(), files = basename(tf))
expect_true(nrow(df1) == 3)
})
test_that("search Glaucis dohrnii sound", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "sound",
path = tempdir())
expect_true(nrow(df1) >= 12)
})
test_that("search Glaucis dohrnii images", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(species = 'Glaucis dohrnii',
format =  "image",
path = tempdir())
expect_true(nrow(df1) >= 10)
})
test_that("paging by date", {
skip_if_not(interactive())
skip_on_cran()
skip_if_offline()
df1 <- query_macaulay(
species = 'Calypte costae',
format = "image",
path = tempdir(),
dates = c(2022, 2024, 2025)
)
expect_true(nrow(df1) >= 15000)
})
test_that("null taxon", {
df1 <- query_macaulay(species = "asdasdasd",
format =  "image",
path = tempdir())
expect_true(is.null(df1))
})
#run document twice
Sys.setenv(XENO_CANTO_API_KEY = getPass::getPass())
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = TRUE, manual = TRUE)
m <- query_macaulay(files = "ML__2025-11-25T17-37_t-11129171.csv", path = "~/Downloads/")
dm <- download_media(m)
dm <- download_media(m, path = "~/Downloads/")
View(m)
m <- query_macaulay(files = "ML__2025-11-25T17-37_t-11129171.csv", path = "~/Downloads/", species = "Calypte ana")
m <- query_macaulay(files = c("ML__2025-11-25T17-37_t-11129171.csv", "ML__2025-11-25T17-37_t-11129171 (copy).csv"), path = "~/Downloads/", species = "Calypte ana")
