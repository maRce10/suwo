length(unique(int$key))
all(table(int$key) == 1)
species = "Ectophylla alba"
format = "image"
cores = getOption("mc.cores", 1)
pb = getOption("pb", TRUE)
verbose = getOption("verbose", TRUE)
identified = FALSE
verifiable = FALSE
all_data = getOption("all_data", FALSE)
raw_data = getOption("raw_data", FALSE)
inat_format <- switch(format, sound = "sounds", image = "photos")
if (!.checkconnection(verb = verbose, service = "inat")) {
return(invisible(NULL))
}
base_url <- paste0(
"https://api.inaturalist.org/v1/observations?",
"per_page=200&",
"taxon_name=", gsub(" ", "%20", species), "&",
inat_format, "=true&",
"identified=", identified, "&",
"verifiable=", verifiable
)
first_query <- try(jsonlite::fromJSON(base_url), silent = TRUE)
if (.is_error(first_query) || is.null(first_query$total_results)) {
if (verbose) {
.message(text = "Metadata could not be downloaded", as = "failure")
}
return(invisible(NULL))
}
total_results <- first_query$total_results
if (total_results == 0) {
if (verbose) {
.message(text = "No matching records found", as = "failure")
}
return(invisible(NULL))
}
if (verbose) {
.message(n = total_results, as = "success")
}
pages <- seq_len(ceiling(total_results / 200))
if (Sys.info()[1] == "Windows" && cores > 1) {
cl <- parallel::makePSOCKcluster(getOption("cl.cores", cores))
} else {
cl <- cores
}
query_output_list <- .pbapply_sw(
pages,
cl = cl,
pbar = pb,
function(page) {
query_output <- try(
jsonlite::fromJSON(paste0(base_url, "&page=", page)),
silent = TRUE
)
if (.is_error(query_output) || is.null(query_output$results)) {
return(NULL)
}
query_output$results <- lapply(
seq_len(nrow(query_output$results)),
function(u) {
x <- as.data.frame(query_output$results[u, ])
media_df <- if (format == "sound")
do.call(rbind, x$sounds)
else
do.call(rbind, x$photos)
media_df <- media_df[!vapply(media_df, is.list, logical(1))]
media_df <- data.frame(media_df)
x <- x[!vapply(x, is.list, logical(1))]
X_df <- data.frame(t(unlist(x)))
X_df <- cbind(X_df, media_df)
X_df
}
)
.merge_data_frames(query_output$results)
}
)
which(int$key == "226787700")
pages
page = 1
query_output <- try(
jsonlite::fromJSON(paste0(base_url, "&page=", page)),
silent = TRUE
)
if (.is_error(query_output) || is.null(query_output$results)) {
return(NULL)
}
seq_len(nrow(query_output$results))
u = 191
x <- as.data.frame(query_output$results[u, ])
x
x$photos
x
head(x)
x[1,]
View(x)
x$photos
media_df <- if (format == "sound")
do.call(rbind, x$sounds)
source("~/Dropbox/R_package_testing/suwo/R/query_inaturalist.R")
int <- query_inaturalist(format = "image")
length(unique(int$key))
all(table(int$key) == 1)
media_df <- if (format == "sound"){
do.call(rbind, x$sounds)} else {
do.call(rbind, x$photos)}
View(media_df)
x$photos
media_df <- if (format == "sound"){
do.call(rbind, x$sounds)
} else {
do.call(rbind, x$photos)
}
media_df <- media_df[!vapply(media_df, is.list, logical(1))]
media_df <- data.frame(media_df)
media_df
str(x)
names(x)
names(x$photos)
head(x$photos)
head(x$observation_photos)
media_df <- if (format == "sound"){
do.call(rbind, x$sounds)
} else {
do.call(rbind, x$photos)
}
media_df <- media_df[!vapply(media_df, is.list, logical(1))]
media_df <- data.frame(media_df)
media_df
x <- x[!vapply(x, is.list, logical(1))]
X_df <- data.frame(t(unlist(x)))
X_df <- cbind(X_df, media_df)
X_df
X_df$url
sub("square", "original", X_df$url)
gsub("square", "original", X_df$url)
query_output_list <- .pbapply_sw(
pages,
cl = cl,
pbar = pb,
function(page) {
query_output <- try(
jsonlite::fromJSON(paste0(base_url, "&page=", page)),
silent = TRUE
)
if (.is_error(query_output) || is.null(query_output$results)) {
return(NULL)
}
query_output$results <- lapply(
seq_len(nrow(query_output$results)),
function(u) {
x <- as.data.frame(query_output$results[u, ])
media_df <- if (format == "sound"){
do.call(rbind, x$sounds)
} else {
do.call(rbind, x$photos)
}
media_df <- media_df[!vapply(media_df, is.list, logical(1))]
media_df <- data.frame(media_df)
x <- x[!vapply(x, is.list, logical(1))]
X_df <- data.frame(t(unlist(x)))
X_df <- cbind(X_df, media_df)
# modify URL so it refers to original file
if (format == "image") {
X_df$url <-  gsub("square", "original", X_df$url)
}
return(X_df)
}
)
.merge_data_frames(query_output$results)
}
)
if (any(vapply(query_output_list, .is_error, logical(1)))) {
if (verbose) {
.message(text = "Metadata could not be downloaded", as = "failure")
}
return(invisible(NULL))
}
query_output_df <- .merge_data_frames(query_output_list)
nrow(query_output_df)
source("~/Dropbox/R_package_testing/suwo/R/query_inaturalist.R")
int <- query_inaturalist(format = "image")
length(unique(int$key))
nrow(int)
nrow(int)
which(int$key == "226787700")
query_output_df <- .merge_data_frames(query_output_list)
head(query_output_df)
which(query_output_df$id == "226787700")
if ("id" %in% names(query_output_df)) {
query_output_df <- query_output_df[!duplicated(query_output_df$id), ]
}
split_location <- do.call(
rbind,
strsplit(as.character(query_output_df$location), ",")
)
query_output_df$latitude  <- split_location[, 1]
query_output_df$longitude <- split_location[, 2]
first_id_index <- which(names(query_output_df) == "id")[1]
if (!is.na(first_id_index)) {
names(query_output_df)[first_id_index] <- "key"
}
query_output_df$key <- as.character(query_output_df$key)
query_output_df$species <- species
query_output_df$file_extension <- sub(
".*\\.",
"",
sub("\\?.*", "",
query_output_df[, grep("url", names(query_output_df), value = TRUE)])
)
query_output_df$country <- NA
query_output_df$date <- substr(
x = query_output_df$time_observed_at,
start = 1,
stop = 10
)
query_output_df$user_name <- vapply(
strsplit(query_output_df$attribution, ","),
"[[",
1,
FUN.VALUE = character(1)
)
query_output_df$user_name[
query_output_df$user_name != "no rights reserved"
] <- vapply(
strsplit(
query_output_df$user_name[
query_output_df$user_name != "no rights reserved"
],
") "
),
"[[",
2,
FUN.VALUE = character(1)
)
which(query_output_df$id == "226787700")
head(query_output_df)
which(query_output_df$key == "226787700")
query_output_df <- .merge_data_frames(query_output_list)
which(query_output_df$id == "226787700")
source("~/Dropbox/R_package_testing/suwo/R/query_inaturalist.R")
int <- query_inaturalist(format = "image")
nrow(int)
length(unique(int$key))
all(table(int$key) == 1)
which(int$key == "226787700")
table(int$key)
source("~/Dropbox/R_package_testing/suwo/R/internal_functions.R")
source("~/Dropbox/R_package_testing/suwo/R/internal_functions.R")
source("~/Dropbox/R_package_testing/suwo/R/query_inaturalist.R")
df1 <- query_inaturalist(species = "Helicobacter pylori", format =  "image")
skip_if(is.null(df1))
nrow(df1) >= 1
nrow(df1)
test_that("search Helicobacter pylori sound", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = "Helicobacter pylori", format =  "image")
skip_if(is.null(df1))
expect_true(nrow(df1) >= 1)
})
library(testthat)
test_that("search Helicobacter pylori sound", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = "Helicobacter pylori", format =  "image")
skip_if(is.null(df1))
expect_true(nrow(df1) >= 1)
})
test_that("search Spatula discors sound (no sounds)", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = 'Spatula discors', format =  "sound",
identified = TRUE, verifiable = TRUE)
skip_if(is.null(df1))
expect_true(nrow(df1) >= 20)
})
test_that("search Glaucis dohrnii photos", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = 'Glaucis dohrnii', format =  "image")
skip_if(is.null(df1))
expect_true(nrow(df1) >=  10)
})
test_that("no result", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = 'asdasdasd', format =  "image")
expect_true(is.null(df1))
})
test_that("search in parallel", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = 'bolitoglossa striatula',
format =  "image",
cores = 2)
skip_if(is.null(df1))
expect_true(nrow(df1) >=  52)
})
options(verbose = TRUE)
test_that("test verbose FALSE", {
skip_on_cran()
skip_if_offline()
df1 <- capture_output(query_inaturalist(
species = 'Glaucis dohrnii',
format =  "sound",
verbose = FALSE
))
skip_if(is.null(df1))
expect_true(df1 == "")
})
test_that("test all_data FALSE", {
skip_on_cran()
skip_if_offline()
df1 <- query_inaturalist(species = 'bolitoglossa striatula',
format =  "image",
all_data = FALSE)
skip_if(is.null(df1))
expected_col_names <- .format_query_output(only_basic_columns = T)
query_col_names <- colnames(df1)
expect_true(
all(expected_col_names %in% query_col_names) &&
all(query_col_names %in% expected_col_names),
info = "Column names do not match the expected names"
)
})
if (!nzchar(Sys.getenv("XENO_CANTO_API_KEY")))
Sys.setenv(XENO_CANTO_API_KEY = getPass::getPass())
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = TRUE, manual = TRUE)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
run.all()
run.all
run.all()
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = TRUE,
format = "image"
)
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
a$downloaded_file_name
all(a$downloaded_file_name %in% expected_files)
run.all()
options(verbose = TRUE)
devtools::test()
df1 <- query_macaulay(taxon_code = "coshum",
species = "asdasd",
format =  "image",
path = tempdir())
nrow(df1) == 10000
lintr::lint_package(linters = list(lintr::line_length_linter()))
lintr::lint_package(linters = list(lintr::line_length_linter()))
codemetar::write_codemeta()
options(species = "Ectophylla alba", verbose = TRUE)
gb <- query_gbif(format = "image")
int <- query_inaturalist(format = "image")
ml <- query_macaulay(taxon_code = "t-11075791",
format = "image",
path = tempdir())
mrg_dat <- merge_metadata(gb, int, ml)
dup_dat <- find_duplicates(mrg_dat)
dup_dat <- find_duplicates(mrg_dat)
source("~/Dropbox/R_package_testing/suwo/R/find_duplicates.R")
dup_dat <- find_duplicates(mrg_dat)
dedup_dat <- remove_duplicates(dup_dat, same_repo = FALSE)
source("~/Dropbox/R_package_testing/suwo/R/remove_duplicates.R")
dedup_dat <- remove_duplicates(dup_dat, same_repo = FALSE)
remove_duplicates(dedup_dat, same_repo = FALSE)
dedup_dat <- remove_duplicates(dedup_dat, same_repo = FALSE)
nrow(dedup_dat)
length(unique(dedup_dat$key))
dir.create(file.path(tempdir(), "ectophylla"))
dl <- download_media(dedup_dat,
path = file.path(tempdir(), "ectophylla"),
cores = 10)
warbleR::open_wd(file.path(tempdir(), "ectophylla"))
options(species = "Artibeus jamaicensis", verbose = TRUE)
gb <- query_gbif(format = "image")
int <- query_inaturalist(format = "image")
ml <- query_macaulay(taxon_code = "t-11075791",
format = "image",
path = tempdir())
mrg_dat <- merge_metadata(gb, int, ml)
mrg_dat <- data.frame()
mrg_dat <- merge_metadata(gb, int, ml, mrg_dat)
exists(mrg_dat)
exists(mrg_dat)
exists("mrg_dat")
mrg_dat
tent_making_bats <- c(
"Uroderma bilobatum",
"Uroderma magnirostrum",
"Artibeus watsoni",
"Ametrida centurio",
"Ectophylla alba",
"Dermanura phaeotis",
"Dermanura cinerea",
"Vampyressa pusilla",
"Vampyressa thyone",
"Mesophylla macconnelli",
"Platyrrhinus helleri",
"Platyrrhinus recifinus",
"Platyrrhinus dorsalis",
"Artibeus toltecus",
"Dermanura tolteca",
"Chiroderma villosum",
"Chiroderma trinitatum",
"Uroderma convexum",
"Vampyriscus bidens",
"Vampyriscus brocki"
)
for (sp in tent_making_bats){
options(species = sp, verbose = TRUE)
gb <- query_gbif(format = "image")
int <- query_inaturalist(format = "image")
# ml <- query_macaulay(taxon_code = "t-11075791",
#                      format = "image",
#                      path = tempdir())
if (!exists("mrg_dat"))
mrg_dat <- merge_metadata(gb, int) else
mrg_dat <- merge_metadata(mrg_dat, gb, int)
}
rm(mrg_dat)
mrg_dat
for (sp in tent_making_bats) {
options(species = sp, verbose = TRUE)
print(sp)
gb <- query_gbif(format = "image")
int <- query_inaturalist(format = "image")
# ml <- query_macaulay(taxon_code = "t-11075791",
#                      format = "image",
#                      path = tempdir())
if (!exists("mrg_dat"))
mrg_dat <- merge_metadata(gb, int)
else
mrg_dat <- merge_metadata(mrg_dat, gb, int)
}
source("~/Dropbox/R_package_testing/suwo/R/merge_metadata.R")
mrg_dat <- merge_metadata(gb, int)
mrg_dat <- merge_metadata(mrg_dat, gb, int)
gb
int
for (sp in tent_making_bats) {
options(species = sp, verbose = TRUE)
print(sp)
gb <- query_gbif(format = "image")
int <- query_inaturalist(format = "image")
# ml <- query_macaulay(taxon_code = "t-11075791",
#                      format = "image",
#                      path = tempdir())
if (!exists("mrg_dat"))
mrg_dat <- merge_metadata(gb, int)
else
mrg_dat <- merge_metadata(mrg_dat, gb, int)
}
dup_dat <- find_duplicates(mrg_dat)
dedup_dat <- remove_duplicates(dup_dat, same_repo = FALSE)
nrow(dedup_dat)
length(unique(dedup_dat$key))
head(dedup_dat)
dl <- download_media(dedup_dat, folder_by = "species",
path = file.path(tempdir()),
cores = 10)
open.wd(tempdir())
warbleR::open_wd(tempdir())
.libPaths()
