"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <-
try(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
# retry if an error occurs waiting 1 s
if (.is_error(query_output)) {
Sys.sleep(1)
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
}
# if error then just return the error
if (.is_error(query_output)){
return(query_output)
}
# make it a data frame
output_df <-
as.data.frame(do.call(rbind, lapply(
query_output$registros$itens, unlist
)))
# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
i <- i + 1
query_output <- try(jsonlite::fromJSON(jsonlite::fromJSON(
paste0(
"https://www.wikiaves.com.br/getRegistrosJSON.php?tm=",
wiki_format,
"&t=",
"s",
"&s=",
id_by_page_df$id[i],
"&o=mp&p=",
id_by_page_df$page[i]
)
), silent = TRUE)
)
source("~/Dropbox/R_package_testing/suwo/R/query_wikiaves.R")
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format = "image")
df1
source("~/Dropbox/R_package_testing/suwo/R/query_wikiaves.R")
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format =  "sound")
options(verbose = TRUE)
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format =  "sound")
df1
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format = "image")
df1
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format = "image")
df1 <- capture_output(query_wikiaves(species = 'a3', format =  "sound",
verbose = FALSE, pb = FALSE))
df1 <- testthat::capture_output(query_wikiaves(species = 'a3', format =  "sound",
verbose = FALSE, pb = FALSE))
df1
library(testthat)
options(verbose = TRUE)
test_that("search Glaucis dohrnii sound", {
skip_on_cran()
skip_if_offline()
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format =  "sound")
skip_if(is.null(df1))
expect_true(nrow(df1) >= 30)
})
test_that("search Glaucis dohrnii photos", {
skip_on_cran()
skip_if_offline()
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format = "image")
skip_if(is.null(df1))
expect_true(nrow(df1) >=  420)
})
test_that("no result", {
skip_on_cran()
skip_if_offline()
df1 <- query_wikiaves(species = 'asdasdasd', format =  "image")
expect_true(is.null(df1))
})
test_that("test verbose FALSE", {
skip_on_cran()
skip_if_offline()
df1 <- testthat::capture_output(query_wikiaves(species = 'a3', format =  "sound",
verbose = FALSE, pb = FALSE))
skip_if(is.null(df1))
expect_true(df1 == "")
})
test_that("test all_data FALSE", {
skip_on_cran()
skip_if_offline()
df1 <- query_wikiaves(species = 'Glaucis dohrnii', format =  "image",
all_data = FALSE)
skip_if(is.null(df1))
expected_col_names <- .format_query_output(only_basic_columns = T)
query_col_names <- colnames(df1)
expect_true(all(query_col_names %in% expected_col_names) &
all(expected_col_names %in% query_col_names),
info = "Column names do not match the expected names")
})
