# fix link
output_df$link <- gsub("#", "", as.character(output_df$link))
return(output_df)
})
query_output_df
query_output_list
# let user know error when downloading metadata
if (any(vapply(query_output_list, .is_error, FUN.VALUE = logical(1)))) {
if (verbose) {
.message(text = "Metadata could not be dowloaded", as = "failure")
}
return(invisible(NULL))
}
any(vapply(query_output_list, .is_error, FUN.VALUE = logical(1)))
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = FALSE, manual = TRUE)
nrow(get_ids)
source("~/Dropbox/R_package_testing/suwo/R/query_wikiaves.R")
length(iris)
devtools::document(".")
source("~/Dropbox/R_package_testing/suwo/R/query_wikiaves.R")
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = FALSE, manual = TRUE)
devtools::document(".")
## pckgcheck
x <- pkgcheck::pkgcheck(".")
summary(x)
codemetar::write_codemeta()
xc1 <- query_xenocanto(
species = 'Phaethornis anthophilus',
all_data = FALSE,
api_key = ""
)
xc1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
df1
sxc1 <- df1[!duplicated(df1$key), ]
sxc1
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir())
df1 <- df1[df1$file_extension == "jpeg", ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
# remove files
unlink(file.path(tempdir(), fls))
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "mp3$")
# remove files
unlink(file.path(tempdir(), fls))
a <- download_media(metadata = sxc1, path = tempdir())
a
# remove files
unlink(file.path(tempdir(), fls))
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
a <- download_media(metadata = sxc1, path = tempdir())
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
skip_if(is.null(df1))
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
fls
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-GBIF5063794756.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
a$downloaded_file_name
a$downloaded_file_name %in% expected_files
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-5077057045.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
skip_if(is.null(df1))
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
View(sxc1)
a <- download_media(metadata = sxc1, path = tempdir(), folder_by = "country")
fls <- list.files(path = tempdir(),
pattern = "jpeg$",
recursive = TRUE)
fls
expected_files <- c(
"Panama/Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Colombia/Phaethornis_anthophilus-5077057045.jpeg"
)
all(expected_files %in% fls)
expected_files
fls
expected_files
all(expected_files %in% fls)
expected_files %in% fls
expected_files <- c(
"Panama/Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Colombia/Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
skip_if(is.null(df1))
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-5077057045.jpeg"
)
all(expected_files %in% fls)
expected_files
fls
all(expected_files %in% fls)
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
skip_if(is.null(df1))
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir(), folder_by = "country")
fls <- list.files(path = tempdir(),
pattern = "jpeg$",
recursive = TRUE)
# remove filess
unlink(file.path(tempdir(), a$downloaded_file_name))
expected_files <- c(
"Panama/Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Colombia/Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = TRUE,
format = "image"
)
skip_if(is.null(df1))
df1 <- df1[df1$key %in%  c("5063794756", "5077057045"), ]
sxc1 <- df1[!duplicated(df1$key), ][1:2, ]
a <- download_media(metadata = sxc1, path = tempdir())
fls <- list.files(path = tempdir(), pattern = "jpeg$")
# remove files
unlink(file.path(tempdir(), fls))
expected_files <- c(
"Phaethornis_anthophilus-GBIF5063794756.jpeg",
"Phaethornis_anthophilus-GBIF5077057045.jpeg"
)
all(expected_files %in% fls)
all(a$downloaded_file_name %in% expected_files)
test_that("update query_xenocanto", {
skip_on_cran()
skip_if_offline()
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
skip_if(is.null(df1))
# remove last 3 rows to test update_metadata
sub_df <- df1[1:(nrow(df1) - 3), ]
up_df <- update_metadata(metadata = sub_df,
api_key = Sys.getenv("XENO_CANTO_API_KEY"))
skip_if(is.null(up_df))
expect_true(nrow(up_df) == nrow(df1))
})
df1 <- query_gbif(
species = 'Phaethornis anthophilus',
all_data = FALSE,
format = "image"
)
# remove last 3 rows to test update_metadata
sub_df <- df1[1:(nrow(df1) - 3), ]
up_df <- update_metadata(metadata = sub_df,
api_key = Sys.getenv("XENO_CANTO_API_KEY"))
is.null(up_df)
nrow(up_df) == nrow(df1)
up_df <- update_metadata(metadata = sub_df)
is.null(up_df)
nrow(up_df) == nrow(df1)
nrow(up_df)
nrow(df1)
up_df <- update_metadata(metadata = sub_df)
# remove last 3 rows to test update_metadata
sub_df <- df1[1:(nrow(df1) - 3), ]
up_df <- update_metadata(metadata = sub_df)
# remove last 3 rows to test update_metadata
sub_df <- df1[df1$key != df1$key[1], ]
up_df <- update_metadata(metadata = sub_df)
nrow(up_df) == nrow(df1)
test_that("check messages", {
skip_on_cran()
skip_if_offline()
msg <- capture_error(
query_xenocanto(species = '000', verbose = TRUE,
api_key = "")
)
expect_true(as.character(msg) ==
paste("Error: An API key is required for Xeno-Canto API v3.",
"Get yours at https://xeno-canto.org/account.\n"))
msg <- capture.output(
a <- query_xenocanto(species = '000', verbose = FALSE,
api_key = Sys.getenv("XENO_CANTO_API_KEY"))
)
expect_true(length(msg) == 0)
msg <- capture.output(
df1 <- query_xenocanto(
species = 'Phaethornis anthophilus',
verbose = TRUE,
pb = FALSE,
api_key = Sys.getenv("XENO_CANTO_API_KEY")
)
)
skip_if(is.null(df1))
expect_true(length(msg) == 0)
})
test_that("bad key", {
skip_on_cran()
skip_if_offline()
msg <- capture_error(
query_xenocanto(species = '000', verbose = TRUE,
api_key = "")
)
expect_true(as.character(msg) ==
paste("Error: An API key is required for Xeno-Canto API v3.",
"Get yours at https://xeno-canto.org/account.\n"))
})
suwo:::.onLoad()
try(suwo:::.onLoad(), silent = TRUE)
suwo:::.onLoad()
dts <- try(suwo:::.onLoad(), silent = TRUE)
is(dts, "try-error")
dts <- try(suwo:::.onUnload(), silent = TRUE)
dts
is.null(dts)
em <- suwo:::.add_emoji("happy")
em <- suwo:::.add_emoji("happy")
em
class(em)
typeof(em)
str(em)
nchar(em)
nchar(em)
nchar(em)
nchar(em)
nchar(em)
nchar(em)
nchar(em) == 1
em <- suwo:::.add_emoji("sad")
em
nchar(em) == 1
# monitor if a new file is added
# added that it breaks after 10 s
.monitor_new_files <- function(path, interval = 1, break.time = 10) {
# Create initial snapshot
prev_snap <- utils::fileSnapshot(
path = path,
full.names = FALSE,
# Return only file names (not full paths)
pattern = "\\.csv$",
recursive = FALSE    # Don't check subfolders
)
# set initial time
start_time <- Sys.time()
while (TRUE) {
# Take new snapshot
current_snap <- utils::fileSnapshot(
path = path,
full.names = FALSE,
pattern = "\\.csv$",
recursive = FALSE
)
# Check elapsed time
elapsed_time <- as.numeric(difftime(Sys.time(), start_time, units = "secs"))
if (elapsed_time > break.time) {
return(NULL)  # Return NULL if break time exceeded
}
# Compare snapshots
changes <- utils::changedFiles(prev_snap, current_snap)
# Return only names of new files
if (length(changes$added) > 0) {
return(changes$added)  # Returns character vector of new file names
}
# Wait before checking again
Sys.sleep(interval)
# Update snapshot for next comparison
prev_snap <- current_snap
}
}
.monitor_new_files()
.monitor_new_files(path = tempdir())
.monitor_new_files(path = tempdir(), break.time = 1)
out <-.monitor_new_files(path = tempdir(), break.time = 0.0001)
out <-suwo:::.monitor_new_files(path = tempdir(), break.time = 0.0001)
Sys.setenv(XENO_CANTO_API_KEY = getPass::getPass())
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = FALSE, manual = TRUE)
em <- suwo:::.add_emoji("happy")
em <- suwo:::.add_emoji("happy")
class(em)
## date ranges
test_that(".date_ranges", {
dts <- suwo:::.date_ranges(x = c(1976, 2020, 2022, 2024, 2025, 2026))
# test
expect_true(nrow(dts) == 5)
dts <- suwo:::.date_ranges(x = seq(1976, 2026, length.out = 50))
expect_true(nrow(dts) == 94)
})
test_that(".onLoad", {
dts <- try(suwo:::.onLoad(), silent = TRUE)
expect_true(is(dts, "try-error"))
})
test_that(".onUnload", {
dts <- try(suwo:::.onUnload(), silent = TRUE)
expect_true(is.null(dts))
})
test_that(".add_emoji", {
em <- suwo:::.add_emoji("happy")
print(class(em))
expect_true(class(em) == "character")
# check if is an emoji
expect_true(nchar(em) == 1)
em <- suwo:::.add_emoji("sad")
# check if is an emoji
expect_true(nchar(em) == 1)
})
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = FALSE, manual = TRUE)
df1 <- query_macaulay(format =  "image",
path = tempdir())
df1 <- query_macaulay(species = "asdasdasd",
format =  "image",
path = tempdir())
is.null(df1)
df1 <- suwo:::vignette_metadata$h_harpyja
df1
df1 <- suwo:::vignette_metadata$h_sarapiquensis
df1
df1 <- suwo:::vignette_metadata$h_sarapiquensis[1:4,]
df1
dir.create(file.path(tempdir(), "downloads"))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
fls
a
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
fls
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
length(unique(a$download_status))
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
length(unique(a$download_status)) == 2
length(unique(a$download_status))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"),
overwrite = TRUE)
test_that("overwrite and already there", {
skip_on_cran()
skip_if_offline()
df1 <- suwo:::vignette_metadata$h_sarapiquensis[1:4,]
dir.create(file.path(tempdir(), "downloads"))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
expect_true(length(unique(a$download_status)) == 3)
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"),
overwrite = TRUE)
expect_true(length(unique(a$download_status)) == 3)
})
test_that("overwrite and already there", {
skip_on_cran()
skip_if_offline()
df1 <- suwo:::vignette_metadata$h_sarapiquensis[1:4,]
dir.create(file.path(tempdir(), "downloads"))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
expect_length(unique(a$download_status), 2)
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"),
overwrite = TRUE)
expect_length(unique(a$download_status), 3)
})
test_that("overwrite and already there", {
skip_on_cran()
skip_if_offline()
df1 <- suwo:::vignette_metadata$h_sarapiquensis[1:4,]
dir.create(file.path(tempdir(), "downloads"))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
expect_length(unique(a$download_status), 3)
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"),
overwrite = TRUE)
expect_length(unique(a$download_status), 2)
})
unlink(file.path(tempdir(), "downloads"))
test_that("overwrite and already there", {
skip_on_cran()
skip_if_offline()
df1 <- suwo:::vignette_metadata$h_sarapiquensis[1:4,]
dir.create(file.path(tempdir(), "downloads"))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
expect_length(unique(a$download_status), 3)
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"),
overwrite = TRUE)
expect_length(unique(a$download_status), 2)
unlink(file.path(tempdir(), "downloads"))
})
unlink(file.path(tempdir(), "downloads"))
unlink(file.path(tempdir(), "downloads"), recursive = TRUE)
test_that("overwrite and already there", {
skip_on_cran()
skip_if_offline()
df1 <- suwo:::vignette_metadata$h_sarapiquensis[1:4,]
dir.create(file.path(tempdir(), "downloads"))
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
fls <- list.files(path = file.path(tempdir(), "downloads"),
pattern = ".jpeg$",
ignore.case = TRUE)
# remove files
unlink(file.path(tempdir(), "downloads" ,  fls[1:2]))
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"))
expect_length(unique(a$download_status), 3)
df1$file_url[4] <- "adasd"
a <- download_media(metadata = df1, path = file.path(tempdir(), "downloads"),
overwrite = TRUE)
expect_length(unique(a$download_status), 2)
unlink(file.path(tempdir(), "downloads"), recursive = TRUE)
})
devtools::document(".")
devtools::check(document = TRUE, run_dont_test = TRUE, vignettes = FALSE, manual = TRUE)
1+1
lintr::lint_package(linters =  list(lintr::line_length_linter()))
library(lintr)
lintr::lint_package(linters =  list(lintr::line_length_linter()))
pkgcheck::pkgcheck(".", use_cache = FALSE)
